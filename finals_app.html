<script>
/* --- sekcja KONFIG --- */
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHw8kX-ehVxqRrBxKQRAH9EySHdQUfPwWEae-llcCwEp-ba7-Oh82Llo-8rHCszQFJiKC7SZt8KaVg/pub?gid=1242680440&single=true&output=csv';
const REFRESH_MS = 180000; // 3 min
const TEAMS = { /* jak poprzednio … */ };
/* ---------------------- */

/* 1. POBRANIE CSV + odrzucenie placeholderów */
let allResults=[];
async function fetchResults(){
  const txt=await(await fetch(CSV_URL)).text();
  const out=[];
  txt.trim().split(/\r?\n/).slice(1).forEach(l=>{
    const c=l.split(/,|;/).map(x=>x.replace(/^"|"$/g,'').trim());
    const pairs=[
      [c[1],c[3],c[4]],   // boisko A
      [c[7],c[9],c[10]]   // boisko B
    ];
    pairs.forEach(([A,B,raw])=>{
      if(/^\d+:\d+$/.test(raw)
         && !/^[1-4][AB]$/.test(A)   // wytnij 1A…4B
         && !/^[1-4][AB]$/.test(B)){
        out.push({teamA:A,teamB:B,raw});
      }
    });
  });
  return allResults=out;
}

/* 2. STATYSTYKI – bez zmian   (initStats, computeStats, sortTeams) */

/* 3. findScore – szuka od końca (ostatni mecz) */
function findScore(a,b){
  for(let i=allResults.length-1;i>=0;i--){
    const r=allResults[i];
    if((r.teamA===a&&r.teamB===b)||(r.teamA===b&&r.teamB===a)){
      const [x,y]=r.raw.split(':');
      return r.teamA===a?`${x}:${y}`:`${y}:${x}`;
    }
  }
  return ':'; // brak
}

/* 4. generowanie par 7/5/3 + populacja tabel */
function populateCourts(st){
  const wA=sortTeams([...st.Kobiety.A]);
  const wB=sortTeams([...st.Kobiety.B]);
  const mA=sortTeams([...st['Mężczyźni'].A]);
  const mB=sortTeams([...st['Mężczyźni'].B]);

  /* półfinały */
  const wSF=[wA[0]?.name||'1A', wB[1]?.name||'2B', wB[0]?.name||'1B', wA[1]?.name||'2A'];
  const mSF=[mA[0]?.name||'1A', mB[1]?.name||'2B', mB[0]?.name||'1B', mA[1]?.name||'2A'];

  /* mecze o 7 i 5 miejsce bierzemy z rankingów */
  const seventh=[ mA[3]?.name||'4A', mB[3]?.name||'4B' ];
  const fifth  =[ mA[2]?.name||'3A', mB[2]?.name||'3B' ];

  /* kto przegrał półfinały? Sprawdzam, czy wynik jest wpisany */
  const semiScoresMen =  findScore(mSF[0],mSF[1]);
  const semiScoresMen2 = findScore(mSF[2],mSF[3]);
  const loser3rd_m = [
    (semiScoresMen!==':'  && Number(semiScoresMen.split(':')[0])<Number(semiScoresMen.split(':')[1]))?mSF[0]:mSF[1],
    (semiScoresMen2!==':' && Number(semiScoresMen2.split(':')[0])<Number(semiScoresMen2.split(':')[1]))?mSF[2]:mSF[3]
  ];
  const thirdMen = semiScoresMen===':'||semiScoresMen2===':' ? ['1A/2B','1B/2A'] : loser3rd_m;

  /* analogicznie kobiety */
  const semiScoresWomen =  findScore(wSF[0],wSF[1]);
  const semiScoresWomen2 = findScore(wSF[2],wSF[3]);
  const loser3rd_w = [
    (semiScoresWomen!==':'  && Number(semiScoresWomen.split(':')[0])<Number(semiScoresWomen.split(':')[1]))?wSF[0]:wSF[1],
    (semiScoresWomen2!==':' && Number(semiScoresWomen2.split(':')[0])<Number(semiScoresWomen2.split(':')[1]))?wSF[2]:wSF[3]
  ];
  const thirdWomen = semiScoresWomen===':'||semiScoresWomen2===':' ? ['1A/2B','1B/2A'] : loser3rd_w;

  /* … poniżej składanie rowsA / rowsB / finals dokładnie tak samo
     jak w poprzedniej odpowiedzi, tylko:
       - wiersz „O 7 miejsce” używa seventh[]
       - „O 5 miejsce”           fifth[]
       - „O 3 miejsce”           thirdWomen / thirdMen
     - do findScore przekazujemy już gotowe nazwy (jak poprzednio)
  */
}

/* 5. pętla init() – bez zmian */

document.getElementById('refresh').addEventListener('click',init);
init();
</script>
