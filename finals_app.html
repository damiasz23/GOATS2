<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turniej ‚Äì Faza Pucharowa</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #fafafa; }
    button#refresh { margin-bottom: 10px; padding: 6px 12px; font-size: 1rem; }
    .bracket-container { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
    .court { flex: 1; }
    .court h2 { text-align: center; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #ddd; }
    tr.phase td { background: #eee; font-weight: bold; }
    tr.women td { background: rgba(255,182,193,0.3); }
    tr.men td   { background: rgba(173,216,230,0.3); }
    tr.break td { background: #f0f0f0; font-weight: bold; }
    .finals { margin-top: 10px; }
    .finals table { width: 100%; }
    .finals th, .finals td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .finals th { background: #ddd; }
  </style>
</head>
<body>
  <button id="refresh">Od≈õwie≈º</button>
  <h1 style="text-align:center;">Faza Pucharowa</h1>

  <div id="brackets" class="bracket-container">
    <!-- Boisko A -->
    <div class="court" id="court-A">
      <h2>Boisko A</h2>
      <table>
        <thead>
          <tr>
            <th>Godz.</th>
            <th>Faza</th>
            <th>Zesp√≥≈Ç A</th>
            <th></th>
            <th>Zesp√≥≈Ç B</th>
            <th>Wynik</th>
          </tr>
        </thead>
        <tbody id="court-A-body">
          <tr><td colspan="6">≈Åadowanie...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Boisko B -->
    <div class="court" id="court-B">
      <h2>Boisko B</h2>
      <table>
        <thead>
          <tr>
            <th>Godz.</th>
            <th>Faza</th>
            <th>Zesp√≥≈Ç A</th>
            <th></th>
            <th>Zesp√≥≈Ç B</th>
            <th>Wynik</th>
          </tr>
        </thead>
        <tbody id="court-B-body">
          <tr><td colspan="6">≈Åadowanie...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Sekcja Fina≈Ç√≥w -->
  <div class="finals">
    <table>
      <thead>
        <tr>
          <th>Godz.</th>
          <th>Faza</th>
          <th>Zesp√≥≈Ç A</th>
          <th></th>
          <th>Zesp√≥≈Ç B</th>
          <th>Wynik</th>
        </tr>
      </thead>
      <tbody id="finals-body">
        <tr><td colspan="6">≈Åadowanie...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // ‚Äî‚Äî Ustawienia ‚Äî‚Äî 
    const REFRESH_MS = 180000; // 3 minuty
    const CSV_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHw8kX-ehVxqRrBxKQRAH9EySHdQUfPwWEae-llcCwEp-ba7-Oh82Llo-8rHCszQFJiKC7SZt8KaVg'
      + '/pub?gid=1242680440&single=true&output=csv';

    // Te same dru≈ºyny jak w fazie grupowej
    const TEAMS = {
      'Mƒô≈ºczy≈∫ni': {
        A: ['Gda≈Ñsk Bukowski Serwis','Ko≈Çobrzeg','Rybnik Team','Pozna≈Ñ Bia≈Çy'],
        B: ['Zielona G√≥ra','TICINO POLAND','SANICOGOLDLUX','Pozna≈Ñ Niebieski']
      },
      'Kobiety': {
        A: ['KOBIETY NA BOISKA ≈Å√≥d≈∫','Lejdis Wroc≈Çaw','Basket Team Gda≈Ñsk','Twarde Babki Toru≈Ñ'],
        B: ['Chy≈ºe Laski Pozna≈Ñ','Warszawa','Rozwa≈ºne i Romantyczne Rybnik']
      }
    };

    // Globalna tablica wszystkich wynik√≥w (grupa + puchary)
    let allResults = [];

    /**
     * Pobierz CSV ‚Üí zwr√≥ƒá tablicƒô obiekt√≥w:
     *   [{ teamA: "...", teamB: "...", raw: "X:Y" }, ‚Ä¶]
     * tylko dla tych wierszy, gdzie kolumna E lub kolumna K ma format "liczba:liczba".
     */
    async function fetchResults() {
      const response = await fetch(CSV_URL);
      const text = await response.text();
      const lines = text.trim().split(/\r?\n/);
      const arr = [];

      lines.forEach((line, idx) => {
        if (idx === 0) return; // pomi≈Ñ nag≈Ç√≥wek CSV

        // Rozbij na kolumny (separator mo≈ºe byƒá przecinek lub ≈õrednik)
        const cols = line.split(/,|;/).map(cell => cell.replace(/^"|"$/g, '').trim());

        // Boisko A: (kolumny: 1,3,4)
        const tA   = cols[1];
        const tB   = cols[3];
        const rawA = cols[4];

        // Boisko B: (kolumny: 7,9,10)
        const tC   = cols[7];
        const tD   = cols[9];
        const rawB = cols[10];

        // Je≈ºeli rawA ma format np. "24:26", dodaj mecz boisko A
        if (/^\d+:\d+$/.test(rawA) && tA && tB) {
          arr.push({ teamA: tA, teamB: tB, raw: rawA });
        }

        // Je≈ºeli rawB ma format np. "33:23", dodaj mecz boisko B
        if (/^\d+:\d+$/.test(rawB) && tC && tD) {
          arr.push({ teamA: tC, teamB: tD, raw: rawB });
        }
      });

      allResults = arr;
      console.log('üçÄ allResults:', allResults);
      return arr;
    }

    /**
     * Zainicjuj strukturƒô do liczenia statystyk fazy grupowej.
     * Zwraca:
     *   { 
     *     "Mƒô≈ºczy≈∫ni": { A: [ {name,pts:0,diff:0}, ‚Ä¶ ], B: [‚Ä¶] },
     *     "Kobiety":    { A: [ ‚Ä¶ ], B: [‚Ä¶] }
     *   }
     */
    function initStats() {
      const stats = {};
      for (const cat in TEAMS) {
        stats[cat] = {};
        for (const grp in TEAMS[cat]) {
          stats[cat][grp] = TEAMS[cat][grp].map(name => ({ name, pts: 0, diff: 0 }));
        }
      }
      return stats;
    }

    /**
     * Oblicza punkty i r√≥≈ºnicƒô tylko dla mecz√≥w grupowych:
     *  - 2 pkt za wygranƒÖ, 1 pkt za przegranƒÖ
     *  - diff = suma( for ‚àí against )
     */
    function computeStats(results) {
      const stats = initStats();

      results.forEach(r => {
        for (const cat in TEAMS) {
          for (const grp in TEAMS[cat]) {
            const teamList = TEAMS[cat][grp];
            if ( teamList.includes(r.teamA) && teamList.includes(r.teamB) ) {
              const [a, b] = r.raw.split(':').map(Number);
              const A = stats[cat][grp].find(x => x.name === r.teamA);
              const B = stats[cat][grp].find(x => x.name === r.teamB);
              if (A && B) {
                A.pts += (a > b ? 2 : 1);
                B.pts += (b > a ? 2 : 1);
                A.diff += (a - b);
                B.diff += (b - a);
              }
            }
          }
        }
      });

      return stats;
    }

    /** 
     * Sortuje tablicƒô obiekt√≥w {name,pts,diff} wg:
     *   1) punkty malejƒÖco
     *   2) diff malejƒÖco
     *   3) nazwa alfabetycznie
     */
    function sortTeams(arr) {
      return arr.sort((a, b) => {
        if (b.pts !== a.pts) return b.pts - a.pts;
        if (b.diff !== a.diff) return b.diff - a.diff;
        return a.name.localeCompare(b.name);
      });
    }

    /**
     * Szuka w tablicy allResults mecz X vs Y:
     *   - zwraca "X:Y" w kolejno≈õci (teamX vs teamY)
     *   - je≈õli znalaz≈Ç mecz w odwrotnej kolejno≈õci (teamY vs teamX), odwraca wynik za Ciebie
     *   - je≈õli meczu nie ma ‚Üí zwraca ":"
     */
    function findScore(teamX, teamY) {
      const match = allResults.find(r =>
        (r.teamA === teamX && r.teamB === teamY) ||
        (r.teamA === teamY && r.teamB === teamX)
      );
      if (!match) return ':';
      const [x, y] = match.raw.split(':').map(Number);
      return (match.teamA === teamX) ? `${x}:${y}` : `${y}:${x}`;
    }

    /**
     * BazujƒÖc na posortowanych statystykach grupowych, wytypuj p√≥≈Çfina≈Çy:
     *   - dla Kobiet: 1A vs 2B oraz 1B vs 2A
     *   - dla Mƒô≈ºczyzn: 1A vs 2B oraz 1B vs 2A
     * Je≈õli brak jeszcze punkt√≥w (tzn team.pts === 0), u≈ºywamy placeholder√≥w "1A","2B"‚Ä¶
     * Zwr√≥ƒá tablice wierszy, kt√≥re nastƒôpnie wype≈Çnimy wynikami.
     */
    function populateCourts(stats) {
      // --- Posortuj zespo≈Çy w ka≈ºdej grupie ---
      const wA = sortTeams([...stats['Kobiety']['A']]);
      const wB = sortTeams([...stats['Kobiety']['B']]);
      const mA = sortTeams([...stats['Mƒô≈ºczy≈∫ni']['A']]);
      const mB = sortTeams([...stats['Mƒô≈ºczy≈∫ni']['B']]);

      // --- Placeholdery do p√≥≈Çfina≈Ç√≥w (Kobiety) ---
      const wPH_A = '1A', wPH_B = '2B', wPH_C = '1B', wPH_D = '2A';
      // lub rzeczywiste nazwy, je≈õli ju≈º gra≈Çy i majƒÖ punkty
      const wSF_A = (wA[0]?.pts > 0) ? wA[0].name : wPH_A;
      const wSF_B = (wB[1]?.pts > 0) ? wB[1].name : wPH_B;
      const wSF_C = (wB[0]?.pts > 0) ? wB[0].name : wPH_C;
      const wSF_D = (wA[1]?.pts > 0) ? wA[1].name : wPH_D;

      // --- Placeholdery do p√≥≈Çfina≈Ç√≥w (Mƒô≈ºczy≈∫ni) ---
      const mPH_A = '1A', mPH_B = '2B', mPH_C = '1B', mPH_D = '2A';
      const mSF_A = (mA[0]?.pts > 0) ? mA[0].name : mPH_A;
      const mSF_B = (mB[1]?.pts > 0) ? mB[1].name : mPH_B;
      const mSF_C = (mB[0]?.pts > 0) ? mB[0].name : mPH_C;
      const mSF_D = (mA[1]?.pts > 0) ? mA[1].name : mPH_D;

      // --- Placeholdery do miejsc 7,5,3 ---
      const p7_A = '4A', p7_B = '4B';
      const p5_A = '3A', p5_B = '3B';
      const p3_A = '1A/2B', p3_B = '1B/2A';

      // --- Przygotuj obiekty reprezentujƒÖce kolejne wiersze Boisko A ---
      const rowsA = [
        // P√≥≈Çfina≈Ç Kobiet na Boisko A
        {
          time: '12:30-13:20',
          phase: 'P√≥≈Çfina≈Ç Kobiet',
          actualA: wSF_A, actualB: wSF_B,
          phA: wPH_A, phB: wPH_B,
          cls: 'women'
        },
        // P√≥≈Çfina≈Ç Mƒô≈ºczyzn na Boisko A
        {
          time: '13:20-14:10',
          phase: 'P√≥≈Çfina≈Ç Mƒô≈ºczyzn',
          actualA: mSF_A, actualB: mSF_B,
          phA: mPH_A, phB: mPH_B,
          cls: 'men'
        },
        // O 7 miejsce (placeholdery 4A vs 4B)
        {
          time: '14:10-15:00',
          phase: 'O 7 miejsce',
          actualA: p7_A, actualB: p7_B,
          phA: p7_A, phB: p7_B,
          cls: 'women'
        },
        // O 5 miejsce (placeholdery 3A vs 3B)
        {
          time: '15:00-15:50',
          phase: 'O 5 miejsce',
          actualA: p5_A, actualB: p5_B,
          phA: p5_A, phB: p5_B,
          cls: 'men'
        },
        // O 3 miejsce (placeholdery 1A/2B vs 1B/2A)
        {
          time: '15:50-16:40',
          phase: 'O 3 miejsce',
          actualA: p3_A, actualB: p3_B,
          phA: p3_A, phB: p3_B,
          cls: 'women'
        },
        // Przerwa techniczna
        { time: 'break', phase: 'PRZERWA TECHNICZNA' }
      ];

      // --- Przygotuj obiekty reprezentujƒÖce kolejne wiersze Boisko B ---
      const rowsB = [
        // P√≥≈Çfina≈Ç Kobiet na Boisko B
        {
          time: '12:30-13:20',
          phase: 'P√≥≈Çfina≈Ç Kobiet',
          actualA: wSF_C, actualB: wSF_D,
          phA: wPH_C, phB: wPH_D,
          cls: 'women'
        },
        // P√≥≈Çfina≈Ç Mƒô≈ºczyzn na Boisko B
        {
          time: '13:20-14:10',
          phase: 'P√≥≈Çfina≈Ç Mƒô≈ºczyzn',
          actualA: mSF_C, actualB: mSF_D,
          phA: mPH_C, phB: mPH_D,
          cls: 'men'
        },
        // O 5 miejsce (placeholder zwykle 3A vs 3B, ale ju≈º wype≈Çnione)
        {
          time: '14:10-15:00',
          phase: 'O 5 miejsce',
          actualA: p5_A, actualB: p5_B,
          phA: p5_A, phB: p5_B,
          cls: 'women'
        },
        // O 3 miejsce (placeholdery 1A/2B vs 1B/2A)
        {
          time: '15:00-15:50',
          phase: 'O 3 miejsce',
          actualA: p3_A, actualB: p3_B,
          phA: p3_A, phB: p3_B,
          cls: 'men'
        },
        // Przerwa techniczna
        { time: 'break', phase: 'PRZERWA TECHNICZNA' }
      ];

      // --- Przygotuj wiersze Fina≈Ç√≥w ---
      const finalRows = [
        {
          time: '17:00-17:50',
          phase: 'Fina≈Ç Kobiet',
          actualA: wSF_A, actualB: wSF_B,
          phA: wPH_A, phB: wPH_B,
          cls: 'women'
        },
        {
          time: '17:50-18:40',
          phase: 'Fina≈Ç Mƒô≈ºczyzn',
          actualA: mSF_A, actualB: mSF_B,
          phA: mPH_A, phB: mPH_B,
          cls: 'men'
        }
      ];

      // ‚Äî‚Äî Renderuj Boisko A ‚Äî‚Äî 
      let htmlA = '';
      rowsA.forEach(r => {
        if (r.time === 'break') {
          htmlA += `<tr class="break"><td colspan="6">${r.phase}</td></tr>`;
        } else {
          // Najpierw spr√≥buj odnale≈∫ƒá wynik wg faktycznych nazw dru≈ºyn
          let score = findScore(r.actualA, r.actualB);
          // Je≈ºeli mamy ":", to znaczy nie znaleziono meczu o tych faktycznych nazwach.
          // Wtedy pr√≥bujemy dopasowaƒá placeholdery (np "1A" vs "2B").
          if (score === ':' && r.phA && r.phB) {
            score = findScore(r.phA, r.phB);
          }
          htmlA += `<tr class="phase"><td>${r.time}</td><td colspan="4">${r.phase}</td><td></td></tr>`;
          htmlA += `
            <tr class="${r.cls}">
              <td></td><td></td>
              <td>${r.actualA}</td>
              <td>vs</td>
              <td>${r.actualB}</td>
              <td>${score}</td>
            </tr>
          `;
        }
      });
      document.getElementById('court-A-body').innerHTML = htmlA;

      // ‚Äî‚Äî Renderuj Boisko B ‚Äî‚Äî 
      let htmlB = '';
      rowsB.forEach(r => {
        if (r.time === 'break') {
          htmlB += `<tr class="break"><td colspan="6">${r.phase}</td></tr>`;
        } else {
          let score = findScore(r.actualA, r.actualB);
          if (score === ':' && r.phA && r.phB) {
            score = findScore(r.phA, r.phB);
          }
          htmlB += `<tr class="phase"><td>${r.time}</td><td colspan="4">${r.phase}</td><td></td></tr>`;
          htmlB += `
            <tr class="${r.cls}">
              <td></td><td></td>
              <td>${r.actualA}</td>
              <td>vs</td>
              <td>${r.actualB}</td>
              <td>${score}</td>
            </tr>
          `;
        }
      });
      document.getElementById('court-B-body').innerHTML = htmlB;

      // ‚Äî‚Äî Renderuj fina≈Çy ‚Äî‚Äî 
      let htmlF = '';
      finalRows.forEach(r => {
        let score = findScore(r.actualA, r.actualB);
        if (score === ':' && r.phA && r.phB) {
          score = findScore(r.phA, r.phB);
        }
        htmlF += `<tr class="phase"><td>${r.time}</td><td colspan="4">${r.phase}</td><td></td></tr>`;
        htmlF += `
          <tr class="${r.cls}">
            <td></td><td></td>
            <td>${r.actualA}</td>
            <td>vs</td>
            <td>${r.actualB}</td>
            <td>${score}</td>
          </tr>
        `;
      });
      document.getElementById('finals-body').innerHTML = htmlF;
    }

    /**
     * G≈Ç√≥wna funkcja:
     * 1) Wy≈õwietl ‚Äû≈Åadowanie...‚Äù w ka≈ºdym <tbody>
     * 2) Pobierz meczowy CSV ‚Üí allResults
     * 3) Policz statystyki grupowe
     * 4) Wywo≈Çaj populateCourts(stats), aby wype≈Çniƒá tabelki
     * 5) Za REFRESH_MS ponownie wywo≈Çaj init()
     */
    async function init() {
      document.getElementById('court-A-body').innerHTML = '<tr><td colspan="6">≈Åadowanie...</td></tr>';
      document.getElementById('court-B-body').innerHTML = '<tr><td colspan="6">≈Åadowanie...</td></tr>';
      document.getElementById('finals-body').innerHTML   = '<tr><td colspan="6">≈Åadowanie...</td></tr>';

      await fetchResults();
      const stats = computeStats(allResults);
      populateCourts(stats);

      setTimeout(init, REFRESH_MS);
    }

    document.getElementById('refresh').addEventListener('click', init);
    init();
  </script>
</body>
</html>
