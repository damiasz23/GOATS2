<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turniej ‚Äì Faza Pucharowa</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #fafafa; }
    button#refresh { margin-bottom: 10px; padding: 6px 12px; font-size: 1rem; }
    .bracket-container { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
    .court { flex: 1; }
    .court h2 { text-align: center; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #ddd; }
    tr.phase td { background: #eee; font-weight: bold; }
    tr.women td { background: rgba(255,182,193,0.3); }
    tr.men td   { background: rgba(173,216,230,0.3); }
    tr.break td { background: #f0f0f0; font-weight: bold; }
    .finals { margin-top: 10px; }
    .finals table { width: 100%; }
    .finals th, .finals td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .finals th { background: #ddd; }
  </style>
</head>
<body>
  <button id="refresh">Od≈õwie≈º</button>
  <h1 style="text-align:center;">Faza Pucharowa</h1>

  <div id="brackets" class="bracket-container">
    <!-- Boisko A -->
    <div class="court" id="court-A">
      <h2>Boisko A</h2>
      <table>
        <thead>
          <tr><th>Godz.</th><th>Faza</th><th>Zesp√≥≈Ç A</th><th></th><th>Zesp√≥≈Ç B</th><th>Wynik</th></tr>
        </thead>
        <tbody id="court-A-body">
          <tr><td colspan="6">≈Åadowanie...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Boisko B -->
    <div class="court" id="court-B">
      <h2>Boisko B</h2>
      <table>
        <thead>
          <tr><th>Godz.</th><th>Faza</th><th>Zesp√≥≈Ç A</th><th></th><th>Zesp√≥≈Ç B</th><th>Wynik</th></tr>
        </thead>
        <tbody id="court-B-body">
          <tr><td colspan="6">≈Åadowanie...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Sekcja Fina≈Ç√≥w -->
  <div class="finals">
    <table>
      <thead>
        <tr><th>Godz.</th><th>Faza</th><th>Zesp√≥≈Ç A</th><th></th><th>Zesp√≥≈Ç B</th><th>Wynik</th></tr>
      </thead>
      <tbody id="finals-body">
        <tr><td colspan="6">≈Åadowanie...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // co ile ms automatycznie od≈õwie≈ºaƒá:
    const REFRESH_MS = 180000; // 180 000 ms = 3 minuty

    // URL do publikowanego CSV z arkusza (kolumny E i K to faza pucharowa)
    const CSV_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHw8kX-ehVxqRrBxKQRAH9EySHdQUfPwWEae-llcCwEp-ba7-Oh82Llo-8rHCszQFJiKC7SZt8KaVg'
      + '/pub?gid=1242680440&single=true&output=csv';

    // Zespo≈Çy w grupach (potrzebne, by wytypowaƒá p√≥≈Çfinalist√≥w)
    const TEAMS = {
      'Mƒô≈ºczy≈∫ni': {
        A: ['Gda≈Ñsk Bukowski Serwis','Ko≈Çobrzeg','Rybnik Team','Pozna≈Ñ Bia≈Çy'],
        B: ['Zielona G√≥ra','TICINO POLAND','SANICOGOLDLUX','Pozna≈Ñ Niebieski']
      },
      'Kobiety': {
        A: ['KOBIETY NA BOISKA ≈Å√≥d≈∫','Lejdis Wroc≈Çaw','Basket Team Gda≈Ñsk','Twarde Babki Toru≈Ñ'],
        B: ['Chy≈ºe Laski Pozna≈Ñ','Warszawa','Rozwa≈ºne i Romantyczne Rybnik']
      }
    };

    // Tablica, w kt√≥rej trzymamy WSZYSTKIE mecze (grupowe + pucharowe)
    let allResults = [];

    /**
     * Funkcja pobiera CSV z publikowanego arkusza, dzieli na wiersze i kolumny,
     * a z kolumn E (indeks 4) i K (indeks 10) wyciƒÖga tylko te wiersze, gdzie
     * jest wynik w formacie ‚Äûliczba:liczba‚Äù. Wtedy wrzuca do allResults:
     *    { teamA: 'XYZ', teamB: 'ABC', raw: 'X:Y' }.
     */
    async function fetchResults() {
      const response = await fetch(CSV_URL);
      const text = await response.text();
      const lines = text.trim().split(/\r?\n/);
      const arr = [];

      lines.forEach((line, idx) => {
        if (idx === 0) return; // pomi≈Ñ nag≈Ç√≥wek CSV

        // Rozbij na kolumny, usu≈Ñ ewentualne cudzys≈Çowy i obci≈õnij bia≈Çe znaki
        const cols = line.split(/,|;/).map(cell => cell.replace(/^"|"$/g, '').trim());

        // Boisko A:
        //   - cols[1] = nazwa dru≈ºyny A
        //   - cols[3] = nazwa dru≈ºyny B
        //   - cols[4] = wynik w formacie ‚ÄûX:Y‚Äù
        const tA   = cols[1];
        const tB   = cols[3];
        const rawA = cols[4];

        // Boisko B:
        //   - cols[7]  = nazwa dru≈ºyny A na boisku B
        //   - cols[9]  = nazwa dru≈ºyny B na boisku B
        //   - cols[10] = wynik w formacie ‚ÄûX:Y‚Äù
        const tC   = cols[7];
        const tD   = cols[9];
        const rawB = cols[10];

        // Je≈ºeli rawA pasuje do ‚Äûliczba:liczba‚Äù ‚Üí push mecz boisko A
        if (/^\d+:\d+$/.test(rawA) && tA && tB) {
          arr.push({ teamA: tA, teamB: tB, raw: rawA });
        }
        // Je≈ºeli rawB pasuje do ‚Äûliczba:liczba‚Äù ‚Üí push mecz boisko B
        if (/^\d+:\d+$/.test(rawB) && tC && tD) {
          arr.push({ teamA: tC, teamB: tD, raw: rawB });
        }
      });

      allResults = arr;
      console.log('üçÄ allResults:', allResults);
      return arr;
    }

    /**
     * PoczƒÖtkowa struktura do liczenia statystyk fazy grupowej. Nie liczymy tu
     * mecz√≥w pucharowych, ale potem u≈ºyjemy tych statystyk do wytypowania p√≥≈Çfina≈Ç√≥w.
     */
    function initStats() {
      const stats = {};
      for (const cat in TEAMS) {
        stats[cat] = {};
        for (const grp in TEAMS[cat]) {
          // Tworzymy tablicƒô obiekt√≥w: { name, pts:0, diff:0 }
          stats[cat][grp] = TEAMS[cat][grp].map(name => ({ name, pts: 0, diff: 0 }));
        }
      }
      return stats;
    }

    /**
     * Na podstawie wszystkich znalezionych wynik√≥w (grupy + puchary) zaktualizuj
     * statystyki fazy grupowej:
     *  - Ka≈ºde zwyciƒôstwo 2 pkt, ka≈ºda pora≈ºka 1 pkt
     *  - diff = suma(for‚àíagainst) w meczach grupowych
     */
    function computeStats(results) {
      const stats = initStats();
      results.forEach(r => {
        for (const cat in TEAMS) {
          for (const grp in TEAMS[cat]) {
            const teamList = TEAMS[cat][grp];
            if (teamList.includes(r.teamA) && teamList.includes(r.teamB)) {
              const [a, b] = r.raw.split(':').map(Number);
              const A = stats[cat][grp].find(x => x.name === r.teamA);
              const B = stats[cat][grp].find(x => x.name === r.teamB);
              if (A && B) {
                // przydziel punkty
                A.pts += (a > b ? 2 : 1);
                B.pts += (b > a ? 2 : 1);
                // przydziel r√≥≈ºnicƒô
                A.diff += (a - b);
                B.diff += (b - a);
              }
            }
          }
        }
      });
      return stats;
    }

    /**
     * Sortuje dru≈ºyny wg. punkt√≥w malejƒÖco ‚Üí diff malejƒÖco ‚Üí nazwa alfabetycznie
     */
    function sortTeams(arr) {
      return arr.sort((a, b) => {
        if (b.pts !== a.pts) return b.pts - a.pts;
        if (b.diff !== a.diff) return b.diff - a.diff;
        return a.name.localeCompare(b.name);
      });
    }

    /**
     * Znajd≈∫ w `allResults` mecz teamX vs teamY. Je≈ºeli jest w odwrotnej kolejno≈õci,
     * odwr√≥ƒá wynik. Je≈ºeli nie ma jeszcze tego meczu lub nie wpisano wyniku, zwr√≥ƒá ‚Äû:‚Äù.
     */
    function findScore(teamX, teamY) {
      const match = allResults.find(r =>
        (r.teamA === teamX && r.teamB === teamY) ||
        (r.teamA === teamY && r.teamB === teamX)
      );
      if (!match) return ':';
      const [x, y] = match.raw.split(':').map(Number);
      return (match.teamA === teamX) ? `${x}:${y}` : `${y}:${x}`;
    }

    /**
     * Na podstawie statystyk grupowych wytypuj p√≥≈Çfina≈Çowe sk≈Çady i wype≈Çnij wszystkie
     * tabelki (Boisko A, Boisko B oraz sekcjƒô fina≈Ç√≥w). Wyniki pobierane sƒÖ wy≈ÇƒÖcznie
     * z findScore(...), kt√≥re odczytuje ‚ÄûallResults‚Äù.
     */
    function populateCourts(stats) {
      // Posortowane (kobiety) grup A/B oraz (mƒô≈ºczy≈∫ni) grup A/B
      const wA = sortTeams([...stats['Kobiety']['A']]);
      const wB = sortTeams([...stats['Kobiety']['B']]);
      const mA = sortTeams([...stats['Mƒô≈ºczy≈∫ni']['A']]);
      const mB = sortTeams([...stats['Mƒô≈ºczy≈∫ni']['B']]);

      // Je≈õli wA[0].pts>0, to to jest rzeczywista 1A, w przeciwnym razie ptsholder '1A'
      const wSF_A = (wA[0]?.pts > 0) ? wA[0].name : '1A';
      const wSF_B = (wB[1]?.pts > 0) ? wB[1].name : '2B';
      const wSF_C = (wB[0]?.pts > 0) ? wB[0].name : '1B';
      const wSF_D = (wA[1]?.pts > 0) ? wA[1].name : '2A';

      const mSF_A = (mA[0]?.pts > 0) ? mA[0].name : '1A';
      const mSF_B = (mB[1]?.pts > 0) ? mB[1].name : '2B';
      const mSF_C = (mB[0]?.pts > 0) ? mB[0].name : '1B';
      const mSF_D = (mA[1]?.pts > 0) ? mA[1].name : '2A';

      // Miejsca 7/5/3 jako placeholdery
      const p7_A = '4A', p7_B = '4B';
      const p5_A = '3A', p5_B = '3B';
      const p3_A = '1A/2B', p3_B = '1B/2A';

      // Wiersze dla Boisko A
      const rowsA = [
        { time:'12:30-13:20', phase:'P√≥≈Çfina≈Ç Kobiet',   teamA:wSF_A, teamB:wSF_B, cls:'women' },
        { time:'13:20-14:10', phase:'P√≥≈Çfina≈Ç Mƒô≈ºczyzn', teamA:mSF_A, teamB:mSF_B, cls:'men'   },
        { time:'14:10-15:00', phase:'O 7 miejsce',       teamA:p7_A,   teamB:p7_B,   cls:'women' },
        { time:'15:00-15:50', phase:'O 5 miejsce',       teamA:p5_A,   teamB:p5_B,   cls:'men'   },
        { time:'15:50-16:40', phase:'O 3 miejsce',       teamA:p3_A,   teamB:p3_B,   cls:'women' },
        { time:'break',      phase:'PRZERWA TECHNICZNA' }
      ];

      // Wiersze dla Boisko B
      const rowsB = [
        { time:'12:30-13:20', phase:'P√≥≈Çfina≈Ç Kobiet',   teamA:wSF_C, teamB:wSF_D, cls:'women' },
        { time:'13:20-14:10', phase:'P√≥≈Çfina≈Ç Mƒô≈ºczyzn', teamA:mSF_C, teamB:mSF_D, cls:'men'   },
        { time:'14:10-15:00', phase:'O 5 miejsce',       teamA:p5_A,   teamB:p5_B,   cls:'women' },
        { time:'15:00-15:50', phase:'O 3 miejsce',       teamA:p3_A,   teamB:p3_B,   cls:'men'   },
        { time:'break',      phase:'PRZERWA TECHNICZNA' }
      ];

      // Wiersze fina≈Ç√≥w
      const finalRows = [
        { time:'17:00-17:50', phase:'Fina≈Ç Kobiet',   teamA:wSF_A, teamB:wSF_B, cls:'women' },
        { time:'17:50-18:40', phase:'Fina≈Ç Mƒô≈ºczyzn', teamA:mSF_A, teamB:mSF_B, cls:'men'   }
      ];

      // ‚Äî‚Äî‚Äî Render Boisko A ‚Äî‚Äî‚Äî
      let htmlA = '';
      rowsA.forEach(r => {
        if (r.time === 'break') {
          htmlA += `<tr class="break"><td colspan="6">${r.phase}</td></tr>`;
        } else {
          const score = findScore(r.teamA, r.teamB);
          htmlA += `<tr class="phase"><td>${r.time}</td><td colspan="4">${r.phase}</td><td></td></tr>`;
          htmlA += `
            <tr class="${r.cls}">
              <td></td>
              <td></td>
              <td>${r.teamA}</td>
              <td>vs</td>
              <td>${r.teamB}</td>
              <td>${score}</td>
            </tr>
          `;
        }
      });
      document.getElementById('court-A-body').innerHTML = htmlA;

      // ‚Äî‚Äî‚Äî Render Boisko B ‚Äî‚Äî‚Äî
      let htmlB = '';
      rowsB.forEach(r => {
        if (r.time === 'break') {
          htmlB += `<tr class="break"><td colspan="6">${r.phase}</td></tr>`;
        } else {
          const score = findScore(r.teamA, r.teamB);
          htmlB += `<tr class="phase"><td>${r.time}</td><td colspan="4">${r.phase}</td><td></td></tr>`;
          htmlB += `
            <tr class="${r.cls}">
              <td></td>
              <td></td>
              <td>${r.teamA}</td>
              <td>vs</td>
              <td>${r.teamB}</td>
              <td>${score}</td>
            </tr>
          `;
        }
      });
      document.getElementById('court-B-body').innerHTML = htmlB;

      // ‚Äî‚Äî‚Äî Render Fina≈Ç√≥w ‚Äî‚Äî‚Äî
      let htmlF = '';
      finalRows.forEach(r => {
        const score = findScore(r.teamA, r.teamB);
        htmlF += `<tr class="phase"><td>${r.time}</td><td colspan="4">${r.phase}</td><td></td></tr>`;
        htmlF += `
          <tr class="${r.cls}">
            <td></td>
            <td></td>
            <td>${r.teamA}</td>
            <td>vs</td>
            <td>${r.teamB}</td>
            <td>${score}</td>
          </tr>
        `;
      });
      document.getElementById('finals-body').innerHTML = htmlF;
    }

    /**
     * G≈Ç√≥wna funkcja: 
     *   1) Wyczy≈õƒá placeholdery,
     *   2) Pobierz dane CSV ‚Üí allResults,
     *   3) Oblicz statystyki grupowe,
     *   4) Wype≈Çnij tabelki fazy pucharowej wynikami,
     *   5) Ustaw automatyczne od≈õwie≈ºenie za REFRESH_MS ms.
     */
    async function init() {
      document.getElementById('court-A-body').innerHTML = '<tr><td colspan="6">≈Åadowanie...</td></tr>';
      document.getElementById('court-B-body').innerHTML = '<tr><td colspan="6">≈Åadowanie...</td></tr>';
      document.getElementById('finals-body').innerHTML   = '<tr><td colspan="6">≈Åadowanie...</td></tr>';

      await fetchResults();
      const stats = computeStats(allResults);
      populateCourts(stats);

      // od≈õwie≈º sam siebie
      setTimeout(init, REFRESH_MS);
    }

    document.getElementById('refresh').addEventListener('click', init);
    init();
  </script>
</body>
</html>
