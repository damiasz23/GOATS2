<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turniej ‚Äì Faza Pucharowa</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #fafafa; }
    button#refresh { margin-bottom: 10px; padding: 6px 12px; font-size: 1rem; }
    .bracket-container { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
    .court { flex: 1; }
    .court h2 { text-align: center; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #ddd; }
    /* wiersz z nazwƒÖ fazy */
    tr.phase td { background: #eee; font-weight: bold; }
    /* wiersze ‚Äûkobiece‚Äù */
    tr.women td { background: rgba(255,182,193,0.3); }
    /* wiersze ‚Äûmƒôskie‚Äù */
    tr.men td   { background: rgba(173,216,230,0.3); }
    /* przerwa techniczna */
    tr.break td { background: #f0f0f0; font-weight: bold; }
    .finals { margin-top: 10px; }
    .finals table { width: 100%; }
    .finals th, .finals td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .finals th { background: #ddd; }
  </style>
</head>
<body>
  <button id="refresh">Od≈õwie≈º</button>
  <h1 style="text-align:center;">Faza Pucharowa</h1>

  <div id="brackets" class="bracket-container">
    <!-- Boisko A -->
    <div class="court" id="court-A">
      <h2>Boisko A</h2>
      <table>
        <thead>
          <tr>
            <th>Godz.</th><th>Faza</th><th>Zesp√≥≈Ç A</th><th></th><th>Zesp√≥≈Ç B</th><th>Wynik</th>
          </tr>
        </thead>
        <tbody id="court-A-body">
          <tr><td colspan="6">≈Åadowanie...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Boisko B -->
    <div class="court" id="court-B">
      <h2>Boisko B</h2>
      <table>
        <thead>
          <tr>
            <th>Godz.</th><th>Faza</th><th>Zesp√≥≈Ç A</th><th></th><th>Zesp√≥≈Ç B</th><th>Wynik</th>
          </tr>
        </thead>
        <tbody id="court-B-body">
          <tr><td colspan="6">≈Åadowanie...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Fina≈Çy sekcja -->
  <div class="finals">
    <table>
      <thead>
        <tr>
          <th>Godz.</th><th>Faza</th><th>Zesp√≥≈Ç A</th><th></th><th>Zesp√≥≈Ç B</th><th>Wynik</th>
        </tr>
      </thead>
      <tbody id="finals-body">
        <tr><td colspan="6">≈Åadowanie...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // Automatyczne od≈õwie≈ºanie co 3 minuty:
    const REFRESH_MS = 180000; 

    // Link do CSV (z kolumnami E i K dla fazy pucharowej)
    const CSV_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vRHw8kX-ehVxqRrBxKQRAH9EySHdQUfPwWEae-llcCwEp-ba7-Oh82Llo-8rHCszQFJiKC7SZt8KaVg'
      + '/pub?gid=1242680440&single=true&output=csv';

    // Definicja dru≈ºyn z fazy grupowej
    const TEAMS = {
      'Mƒô≈ºczy≈∫ni': {
        A: ['Gda≈Ñsk Bukowski Serwis','Ko≈Çobrzeg','Rybnik Team','Pozna≈Ñ Bia≈Çy'],
        B: ['Zielona G√≥ra','TICINO POLAND','SANICOGOLDLUX','Pozna≈Ñ Niebieski']
      },
      'Kobiety': {
        A: ['KOBIETY NA BOISKA ≈Å√≥d≈∫','Lejdis Wroc≈Çaw','Basket Team Gda≈Ñsk','Twarde Babki Toru≈Ñ'],
        B: ['Chy≈ºe Laski Pozna≈Ñ','Warszawa','Rozwa≈ºne i Romantyczne Rybnik']
      }
    };

    // Przechowuje **wszystkie** mecze (grupowe + pucharowe)
    let allResults = [];

    /**
     * Pobiera CSV i zwraca tablicƒô obiekt√≥w:
     *   { teamA:"nazwaA", teamB:"nazwaB", raw:"X:Y" }
     * tylko wtedy, gdy raw ma format liczba:liczba (cyfra:cyfra),
     * z kolumny E (boisko A) lub K (boisko B).
     */
    async function fetchResults() {
      const response = await fetch(CSV_URL);
      const text = await response.text();
      const lines = text.trim().split(/\r?\n/);

      const arr = [];
      lines.forEach((line, idx) => {
        if (idx === 0) return; // pomi≈Ñ nag≈Ç√≥wek CSV
        const cols = line.split(/,|;/).map(cell => cell.replace(/^"|"$/g,'').trim());

        // Boisko A: nazwy dru≈ºyn to cols[1] i cols[3], wynik to cols[4]
        const tA = cols[1], tB = cols[3], rawA = cols[4];
        if (/^\d+:\d+$/.test(rawA) && tA && tB) {
          arr.push({ teamA: tA, teamB: tB, raw: rawA });
        }

        // Boisko B: nazwy dru≈ºyn to cols[7] i cols[9], wynik to cols[10]
        const tC = cols[7], tD = cols[9], rawB = cols[10];
        if (/^\d+:\d+$/.test(rawB) && tC && tD) {
          arr.push({ teamA: tC, teamB: tD, raw: rawB });
        }
      });

      allResults = arr;
      return arr;
    }

    /**
     * Tworzy poczƒÖtkowe statystyki (tylko faza grupowa):
     *   {
     *     "Mƒô≈ºczy≈∫ni": {
     *       "A":[{name:...,pts:0,diff:0}, ...], 
     *       "B":[...] 
     *     },
     *     "Kobiety": { "A":[...], "B":[...] }
     *   }
     */
    function initStats() {
      const stats = {};
      for (const cat in TEAMS) {
        stats[cat] = {};
        for (const grp in TEAMS[cat]) {
          stats[cat][grp] = TEAMS[cat][grp].map(name => ({
            name, pts: 0, diff: 0
          }));
        }
      }
      return stats;
    }

    /**
     * Na podstawie wszystkich mecz√≥w (grupowe + pucharowe)
     * liczy punkty i r√≥≈ºnicƒô **tylko dla fazy grupowej**:
     *   - za zwyciƒôstwo 2 pkt, przegranƒÖ 1 pkt,
     *   - diff = suma (for ‚àí against).
     */
    function computeStats(results) {
      const stats = initStats();
      results.forEach(r => {
        for (const cat in TEAMS) {
          for (const grp in TEAMS[cat]) {
            const teamList = TEAMS[cat][grp];
            if (teamList.includes(r.teamA) && teamList.includes(r.teamB)) {
              const [a, b] = r.raw.split(':').map(Number);
              const A = stats[cat][grp].find(x => x.name === r.teamA);
              const B = stats[cat][grp].find(x => x.name === r.teamB);
              if (A && B) {
                // punkty
                if (a > b) {
                  A.pts += 2; B.pts += 1;
                } else {
                  B.pts += 2; A.pts += 1;
                }
                // r√≥≈ºnica
                A.diff += (a - b);
                B.diff += (b - a);
              }
            }
          }
        }
      });
      return stats;
    }

    /**
     * Sortuje tablicƒô [{name,pts,diff},...] wg:
     *   1) pts malejƒÖco, 2) diff malejƒÖco, 3) name alfabetycznie.
     */
    function sortTeams(arr) {
      return arr.sort((a, b) => {
        if (b.pts !== a.pts) return b.pts - a.pts;
        if (b.diff !== a.diff) return b.diff - a.diff;
        return a.name.localeCompare(b.name);
      });
    }

    /**
     * Zwraca ostatni (naj≈õwie≈ºszy) wynik z allResults dla pary (teamX, teamY).
     * Je≈ºeli jest wpis np. {teamA:"1A",teamB:"2B",raw:"24:26"} ale potem powt√≥rka
     * {teamA:"1A",teamB:"2B",raw:"32:44"}, to u≈ºyje tego drugiego (ostatniego).
     * Je≈õli nie znajdzie ≈ºadnego meczu ‚Üí zwraca ':'.
     */
    function findScore(teamX, teamY) {
      // przeszukujemy od ko≈Ñca:
      for (let i = allResults.length - 1; i >= 0; i--) {
        const r = allResults[i];
        if (
          (r.teamA === teamX && r.teamB === teamY) ||
          (r.teamA === teamY && r.teamB === teamX)
        ) {
          const [x, y] = r.raw.split(':').map(Number);
          return (r.teamA === teamX) ? `${x}:${y}` : `${y}:${x}`;
        }
      }
      return ':';
    }

    /**
     * Na podstawie statystyk grupowych wybiera p√≥≈Çfinalist√≥w (jezÃáeli ju≈º majƒÖ mecz, to prawdziwe nazwy,
     * w przeciwnym wypadku placeholdery "1A","2B" itd.) i generuje wszystkie wiersze:
     *   - P√≥≈Çfina≈Çy / O 7 miejsce / O 5 miejsce / O 3 miejsce / Fina≈Çy
     * Ka≈ºdy wiersz odwo≈Çuje siƒô do findScore(phA, phB), ≈ºeby wyciƒÖgnƒÖƒá wynik z allResults
     * (pole raw) dla danego placeholdera pary.
     */
    function populateCourts(stats) {
      // 1) Sortujemy grupy:
      const wA_sorted = sortTeams([...stats['Kobiety']['A']]);
      const wB_sorted = sortTeams([...stats['Kobiety']['B']]);
      const mA_sorted = sortTeams([...stats['Mƒô≈ºczy≈∫ni']['A']]);
      const mB_sorted = sortTeams([...stats['Mƒô≈ºczy≈∫ni']['B']]);

      // 2) Ustalamy placeholdery i faktyczne nazwy (je≈õli ju≈º majƒÖ punkty):
      // Kobiety
      const wSF_A_ph = '1A', wSF_B_ph = '2B', wSF_C_ph = '1B', wSF_D_ph = '2A';
      const wSF_A_name = (wA_sorted[0]?.pts > 0) ? wA_sorted[0].name : wSF_A_ph;
      const wSF_B_name = (wB_sorted[1]?.pts > 0) ? wB_sorted[1].name : wSF_B_ph;
      const wSF_C_name = (wB_sorted[0]?.pts > 0) ? wB_sorted[0].name : wSF_C_ph;
      const wSF_D_name = (wA_sorted[1]?.pts > 0) ? wA_sorted[1].name : wSF_D_ph;

      // Mƒô≈ºczy≈∫ni
      const mSF_A_ph = '1A', mSF_B_ph = '2B', mSF_C_ph = '1B', mSF_D_ph = '2A';
      const mSF_A_name = (mA_sorted[0]?.pts > 0) ? mA_sorted[0].name : mSF_A_ph;
      const mSF_B_name = (mB_sorted[1]?.pts > 0) ? mB_sorted[1].name : mSF_B_ph;
      const mSF_C_name = (mB_sorted[0]?.pts > 0) ? mB_sorted[0].name : mSF_C_ph;
      const mSF_D_name = (mA_sorted[1]?.pts > 0) ? mA_sorted[1].name : mSF_D_ph;

      // Pozosta≈Çe fazy ‚Äì placeholdery
      const p7_A_ph = '4A', p7_B_ph = '4B';
      const p5_A_ph = '3A', p5_B_ph = '3B';
      const p3_A_ph = '1A/2B', p3_B_ph = '1B/2A';

      // --- Budujemy wiersze Boisko A ---
      const rowsA = [
        // üü• P√≥≈Çfina≈Ç Kobiet
        {
          time:  '12:30-13:20',
          phase: 'P√≥≈Çfina≈Ç Kobiet',
          phA:   wSF_A_ph, 
          phB:   wSF_B_ph,
          nameA: wSF_A_name,
          nameB: wSF_B_name,
          cls:   'women'
        },
        // üü¶ P√≥≈Çfina≈Ç Mƒô≈ºczyzn
        {
          time:  '13:20-14:10',
          phase: 'P√≥≈Çfina≈Ç Mƒô≈ºczyzn',
          phA:   mSF_A_ph,
          phB:   mSF_B_ph,
          nameA: mSF_A_name,
          nameB: mSF_B_name,
          cls:   'men'
        },
        // üü• O 7 miejsce
        {
          time:  '14:10-15:00',
          phase: 'O 7 miejsce',
          phA:   p7_A_ph,
          phB:   p7_B_ph,
          nameA: p7_A_ph,
          nameB: p7_B_ph,
          cls:   'women'
        },
        // üü¶ O 5 miejsce
        {
          time:  '15:00-15:50',
          phase: 'O 5 miejsce',
          phA:   p5_A_ph,
          phB:   p5_B_ph,
          nameA: p5_A_ph,
          nameB: p5_B_ph,
          cls:   'men'
        },
        // üü• O 3 miejsce
        {
          time:  '15:50-16:40',
          phase: 'O 3 miejsce',
          phA:   p3_A_ph,
          phB:   p3_B_ph,
          nameA: p3_A_ph,
          nameB: p3_B_ph,
          cls:   'women'
        },
        // PRZERWA
        {
          time:  'break',
          phase: 'PRZERWA TECHNICZNA'
        }
      ];

      // --- Budujemy wiersze Boisko B ---
      const rowsB = [
        // üü• P√≥≈Çfina≈Ç Kobiet (druga para)
        {
          time:  '12:30-13:20',
          phase: 'P√≥≈Çfina≈Ç Kobiet',
          phA:   wSF_C_ph, 
          phB:   wSF_D_ph,
          nameA: wSF_C_name,
          nameB: wSF_D_name,
          cls:   'women'
        },
        // üü¶ P√≥≈Çfina≈Ç Mƒô≈ºczyzn (druga para)
        {
          time:  '13:20-14:10',
          phase: 'P√≥≈Çfina≈Ç Mƒô≈ºczyzn',
          phA:   mSF_C_ph,
          phB:   mSF_D_ph,
          nameA: mSF_C_name,
          nameB: mSF_D_name,
          cls:   'men'
        },
        // üü• O 5 miejsce (kobiety)
        {
          time:  '14:10-15:00',
          phase: 'O 5 miejsce',
          phA:   p5_A_ph,
          phB:   p5_B_ph,
          nameA: p5_A_ph,
          nameB: p5_B_ph,
          cls:   'women'
        },
        // üü¶ O 3 miejsce (mƒô≈ºczy≈∫ni)
        {
          time:  '15:00-15:50',
          phase: 'O 3 miejsce',
          phA:   p3_A_ph,
          phB:   p3_B_ph,
          nameA: p3_A_ph,
          nameB: p3_B_ph,
          cls:   'men'
        },
        // PRZERWA
        {
          time:  'break',
          phase: 'PRZERWA TECHNICZNA'
        }
      ];

      // --- Budujemy wiersze Fina≈Ç√≥w ---
      const finalRows = [
        // üü• Fina≈Ç Kobiet
        {
          time:  '17:00-17:50',
          phase: 'Fina≈Ç Kobiet',
          phA:   wSF_A_ph,
          phB:   wSF_B_ph,
          nameA: wSF_A_name,
          nameB: wSF_B_name,
          cls:   'women'
        },
        // üü¶ Fina≈Ç Mƒô≈ºczyzn
        {
          time:  '17:50-18:40',
          phase: 'Fina≈Ç Mƒô≈ºczyzn',
          phA:   mSF_A_ph,
          phB:   mSF_B_ph,
          nameA: mSF_A_name,
          nameB: mSF_B_name,
          cls:   'men'
        }
      ];

      // -------------------------------------------------------------------------
      // Teraz wypisujemy ka≈ºdy rzƒÖd do odpowiedniego <tbody> w HTML-u:
      // -------------------------------------------------------------------------

      // --- Boisko A ---
      let htmlA = '';
      rowsA.forEach(r => {
        if (r.time === 'break') {
          htmlA += `<tr class="break"><td colspan="6">${r.phase}</td></tr>`;
        } else {
          const score = findScore(r.phA, r.phB);
          htmlA += `
            <tr class="phase">
              <td>${r.time}</td>
              <td colspan="4">${r.phase}</td>
              <td></td>
            </tr>
            <tr class="${r.cls}">
              <td></td><td></td>
              <td>${r.nameA}</td>
              <td>vs</td>
              <td>${r.nameB}</td>
              <td>${score}</td>
            </tr>
          `;
        }
      });
      document.getElementById('court-A-body').innerHTML = htmlA;

      // --- Boisko B ---
      let htmlB = '';
      rowsB.forEach(r => {
        if (r.time === 'break') {
          htmlB += `<tr class="break"><td colspan="6">${r.phase}</td></tr>`;
        } else {
          const score = findScore(r.phA, r.phB);
          htmlB += `
            <tr class="phase">
              <td>${r.time}</td>
              <td colspan="4">${r.phase}</td>
              <td></td>
            </tr>
            <tr class="${r.cls}">
              <td></td><td></td>
              <td>${r.nameA}</td>
              <td>vs</td>
              <td>${r.nameB}</td>
              <td>${score}</td>
            </tr>
          `;
        }
      });
      document.getElementById('court-B-body').innerHTML = htmlB;

      // --- Fina≈Çy ---
      let htmlF = '';
      finalRows.forEach(r => {
        const score = findScore(r.phA, r.phB);
        htmlF += `
          <tr class="phase">
            <td>${r.time}</td>
            <td colspan="4">${r.phase}</td>
            <td></td>
          </tr>
          <tr class="${r.cls}">
            <td></td><td></td>
            <td>${r.nameA}</td>
            <td>vs</td>
            <td>${r.nameB}</td>
            <td>${score}</td>
          </tr>
        `;
      });
      document.getElementById('finals-body').innerHTML = htmlF;
    }

    /**
     * G≈Ç√≥wna funkcja:
     *   1) Wyczy≈õƒá placeholdery w tabelach,
     *   2) Pobierz CSV do allResults,
     *   3) Oblicz statystyki grupowe,
     *   4) Uzupe≈Çnij wszƒôdzie odpowiednie wiersze (populateCourts),
     *   5) Ustaw samood≈õwie≈ºanie po 3 minutach.
     */
    async function init() {
      document.getElementById('court-A-body').innerHTML = '<tr><td colspan="6">≈Åadowanie...</td></tr>';
      document.getElementById('court-B-body').innerHTML = '<tr><td colspan="6">≈Åadowanie...</td></tr>';
      document.getElementById('finals-body').innerHTML   = '<tr><td colspan="6">≈Åadowanie...</td></tr>';

      await fetchResults();
      const stats = computeStats(allResults);
      populateCourts(stats);

      setTimeout(init, REFRESH_MS);
    }

    document.getElementById('refresh').addEventListener('click', init);
    init();
  </script>
</body>
</html>
